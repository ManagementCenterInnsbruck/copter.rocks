/*******************************************************************************
**                      Author(s) Identity                                    **
********************************************************************************
**                                                                            **
** Initials     Name                                                          **
** ---------------------------------------------------------------------------**
** RT           Rafael  Tschinder                                             **
** DW           Dominik Wieland                                               **
**                                                                            **
**                                                                            **
*******************************************************************************/

/*******************************************************************************
**                      Revision Control History                              **
*******************************************************************************/
/*
 * V0.0: 16-03-2016, RT:  Initial Version
 * V0.1: 21-07-2016, DW:  Port of SW from DAVE3 to DAVE4
 */


/*******************************************************************************
**                      Includes                                              **
*******************************************************************************/
#include "BatterySafety.h"

/*******************************************************************************
**                      Private Constant Definitions to be changed            **
*******************************************************************************/

/*******************************************************************************
**                      Private Macro Definitions                             **
*******************************************************************************/

/*******************************************************************************
**                      Global Type Definitions                               **
*******************************************************************************/

/*******************************************************************************
**                      Private Type Definitions                              **
*******************************************************************************/

/*******************************************************************************
**                      Global Function Declarations                          **
*******************************************************************************/

/*******************************************************************************
**                      Private Function Declarations                         **
*******************************************************************************/

/*******************************************************************************
**                      Global Constant Definitions                           **
*******************************************************************************/

/*******************************************************************************
**                      Private Constant Definitions                          **
*******************************************************************************/

/*******************************************************************************
**                      Global Variable Definitions                           **
*******************************************************************************/

/*******************************************************************************
**                      Private Variable Definitions                          **
*******************************************************************************/

/*******************************************************************************
**                      Global Function Definitions                           **
*******************************************************************************/

/*******************************************************************************
**                      Private Function Definitions                          **
*******************************************************************************/
/**
 *  \brief ADC result interrupt service routine
 *  
 *  
 *  \details switches on the right LEDs for each charge stand\n
 * All LEDs on -> Battery Voltage > 12V \n
 * Yellow and Red LED on -> Battery Voltage 12V - 11V\n
 * Red LED on -> Battery Voltage 11V - 10.5V\n
 * Red LED flashing -> Battery Voltage < 10.5V\n
 * The VBat Pin has to be connected to the right Pin of the Bat Safety Connector, and R13 must be min. 30kOhm and C29(10uF) has to be mounted.\n
 */

void VBat_Measurement_ISR(void)
{
	XMC_VADC_RESULT_SIZE_t ADC_Result = ADC_MEASUREMENT_GetResult(&ADC_MEASUREMENT_Channel_VBat);

	//LED Display
	if (ADC_Result > Battery_State1)
	{
		Set(P3_0); 		 //VBat_LED_Green
		Set(P3_1);		 //VBat_LED_Yellow
		Set(P3_2);		 //VBat_LED_Red
	}
	else if (ADC_Result > Battery_State2)
	{
		Reset(P3_0);	//VBat_LED_Green
		Set(P3_1);		//VBat_LED_Yellow
		Set(P3_2);		//VBat_LED_Red
	}
	else if (ADC_Result > Battery_State3)
	{
		Reset(P3_0);	//VBat_LED_Green
		Reset(P3_1);	//VBat_LED_Yellow
		Set(P3_2);		//VBat_LED_Red
	}
	else
	{
		Reset(P3_0);	//VBat_LED_Green
		Reset(P3_1);	//VBat_LED_Yellow
		Toggle(P3_2);	//VBat_LED_Red
	}
}
